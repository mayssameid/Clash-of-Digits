<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Leaderboard - Clash of Digits</title>
  <link rel="stylesheet" href="nav.css">
  <link rel="stylesheet" href="leaderboard.css">
  <link href="https://unpkg.com/aos@2.3.1/dist/aos.css" rel="stylesheet">
  
  <!-- React and ReactDOM from CDN -->
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <!-- Babel Standalone for JSX -->
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
</head>
<body>
  <div id="particles-js"></div>
  
  <nav class="navbar" data-aos="fade-down"></nav>
  
  <main>
    <div id="root"></div>
  </main>

  <script src="https://unpkg.com/aos@2.3.1/dist/aos.js"></script>
  <script src="https://cdn.jsdelivr.net/particles.js/2.0.0/particles.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/howler@2.2.3/dist/howler.min.js"></script>
  <script src="game-music.js"></script>
  
  <script type="text/babel">
    // React Hooks: useState manages component state, useEffect handles side effects
    const { useState, useEffect } = React;
    
    // API URL dynamically switches between local development and production
    // Works with both Live Server (5500) and Node server (3000)
    const API_URL = window.location.port === '5500'
      ? 'http://localhost:3000/api'
      : window.location.hostname === 'localhost' 
      ? 'http://localhost:3000/api' 
      : '/api';

    // Main Leaderboard Component - React functional component using hooks
    function Leaderboard() {
      // useState Hook: Manages leaderboard data array fetched from API
      const [leaderboardData, setLeaderboardData] = useState([]);
      
      // useState Hook: Manages search input value for player lookup
      const [searchQuery, setSearchQuery] = useState('');
      
      // useState Hook: Stores individual player search result object
      const [searchResult, setSearchResult] = useState(null);
      
      // useState Hook: Controls loading state for better UX
      const [loading, setLoading] = useState(true);
      
      // useState Hook: Stores error messages for display
      const [error, setError] = useState(null);

      // useEffect Hook: Runs once on component mount (empty dependency array [])
      // Automatically fetches leaderboard data when page loads
      useEffect(() => {
        fetchLeaderboard();
      }, []);

      // Async function to fetch leaderboard data from backend API
      const fetchLeaderboard = async () => {
        try {
          // Set loading to true before fetching (updates UI)
          setLoading(true);
          
          // Fetch API call to backend endpoint
          const response = await fetch(`${API_URL}/leaderboard`);
          
          // Error handling: check if response is successful
          if (!response.ok) {
            throw new Error('Failed to load leaderboard');
          }
          
          // Parse JSON response and update state
          const data = await response.json();
          setLeaderboardData(data); // Update leaderboard data state
          setError(null); // Clears any previous errors
        } catch (err) {
          console.error('Error loading leaderboard:', err);
          setError('Unable to load leaderboard. Please try again later.');
        } finally {
          // Always set loading to false when done (success or error)
          setLoading(false);
        }
      };

      // Event handler for player search form submission
      const handleSearch = async (e) => {
        e.preventDefault(); // Prevent default form submission behavior
        
        // Validation: ensure search query is not empty
        if (!searchQuery.trim()) {
          alert('Please enter a player name');
          return;
        }

        try {
          // Fetch specific player data using search query
          // encodeURIComponent prevents URL injection attacks
          const response = await fetch(`${API_URL}/player/search?name=${encodeURIComponent(searchQuery)}`);
          
          if (!response.ok) {
            throw new Error('Player not found');
          }
          
          // Update search result state with player data
          const data = await response.json();
          setSearchResult(data);
        } catch (err) {
          console.error('Error searching player:', err);
          alert('Player not found. Please try a different name.');
          setSearchResult(null); // Clear previous results
        }
      };

      // Clear search functionality - resets search state
      const clearSearch = () => {
        setSearchQuery(''); // Clear input field
        setSearchResult(null); // Remove search results
      };

      // JSX Return: React component's rendered output
      // Uses conditional rendering with && and ternary operators
      return (
        <>
          <section className="leaderboard-section" data-aos="fade-up">
            <h1 data-aos="zoom-in" data-aos-delay="100">üèÜ Leaderboard</h1>
            <p className="subtitle" data-aos="fade-in" data-aos-delay="200">
              Top Players in Math Duel Arena
            </p>

            <div className="leaderboard-container" data-aos="slide-up" data-aos-delay="300">
              {/* Conditional Rendering: Show loading message while fetching data */}
              {loading && <p className="loading-message">Loading leaderboard...</p>}
              
              {/* Conditional Rendering: Display error if fetch fails */}
              {error && <p className="error-message">{error}</p>}
              
              {/* Conditional Rendering: Show message when no players exist */}
              {!loading && !error && leaderboardData.length === 0 && (
                <p className="no-data-message">No players yet. Be the first to play!</p>
              )}
              
              {/* Conditional Rendering: Display leaderboard table when data exists */}
              {!loading && !error && leaderboardData.length > 0 && (
                <table className="leaderboard-table">
                  <thead>
                    <tr>
                      <th>Rank</th>
                      <th>Player Name</th>
                      <th>Total Score</th>
                      <th>Games Played</th>
                      <th>Avg Score</th>
                    </tr>
                  </thead>
                  <tbody>
                    {/* Array.map() renders each player as a table row */}
                    {/* Key prop required for React's efficient rendering */}
                    {leaderboardData.map((player, index) => (
                      <tr key={player.user_id} className={index < 3 ? `rank-${index + 1}` : ''}>
                        <td>
                          {index === 0 && 'ü•á'}
                          {index === 1 && 'ü•à'}
                          {index === 2 && 'ü•â'}
                          {index > 2 && `#${index + 1}`}
                        </td>
                        <td className="player-name">{player.username}</td>
                        <td>{player.total_score}</td>
                        <td>{player.games_played}</td>
                        <td>{parseFloat(player.average_score).toFixed(1)}</td>
                      </tr>
                    ))}
                  </tbody>
                </table>
              )}
            </div>
          </section>

          <div className="player-search-section" data-aos="fade-up" data-aos-delay="400">
            <h2>üîç Search Player Stats</h2>
            {/* Controlled Form Component: onSubmit calls handleSearch function */}
            <form onSubmit={handleSearch} className="search-form">
              {/* Controlled Input: value prop bound to searchQuery state */}
              {/* onChange updates state on every keystroke (two-way binding) */}
              <input
                type="text"
                value={searchQuery}
                onChange={(e) => setSearchQuery(e.target.value)}
                placeholder="Enter player name..."
                className="search-input"
              />
              <button type="submit" className="search-button">Search</button>
              {/* Conditional Rendering: Show clear button only when results exist */}
              {searchResult && (
                <button type="button" onClick={clearSearch} className="clear-button">Clear</button>
              )}
            </form>

            {/* Conditional Rendering: Display player stats only when search succeeds */}
            {searchResult && (
              <div className="player-stats-result" data-aos="zoom-in">
                <h3>Player Statistics</h3>
                <div className="stats-grid">
                  <div className="stat-item">
                    <span className="stat-label">Player:</span>
                    <span className="stat-value">{searchResult.username}</span>
                  </div>
                  <div className="stat-item">
                    <span className="stat-label">Total Score:</span>
                    <span className="stat-value">{searchResult.total_score || 0}</span>
                  </div>
                  <div className="stat-item">
                    <span className="stat-label">Games Played:</span>
                    <span className="stat-value">{searchResult.games_played || 0}</span>
                  </div>
                  <div className="stat-item">
                    <span className="stat-label">Average Score:</span>
                    <span className="stat-value">
                      {searchResult.average_score ? parseFloat(searchResult.average_score).toFixed(1) : '0.0'}
                    </span>
                  </div>
                </div>
              </div>
            )}
          </div>
        </>
      );
    }

    // ReactDOM.render: Mounts the React component to the DOM
    // First argument: React component to render
    // Second argument: DOM element where component will be inserted
    ReactDOM.render(<Leaderboard />, document.getElementById('root'));

    // Initialize AOS (Animate On Scroll) library after React renders
    AOS.init({ duration: 1000, easing: 'ease-in-out', once: true });
    
    particlesJS('particles-js', {
      particles: {
        number: { value: 25 },
        color: { value: ["#0fcece", "#e94560"] },
        shape: { type: "circle" },
        opacity: { value: 0.1 },
        size: { value: 8 },
        line_linked: { enable: true, distance: 150, color: "#0fcece", opacity: 0.05 },
        move: { enable: true, speed: 1.5 }
      },
      interactivity: {
        events: { onhover: { enable: true, mode: "grab" } },
        modes: { grab: { distance: 140 } }
      }
    });
  </script>

  <script>
    // Load navigation
    fetch('nav.html')
      .then(response => response.text())
      .then(data => {
        document.querySelector('.navbar').innerHTML = data;
      });
  </script>
</body>
</html>
